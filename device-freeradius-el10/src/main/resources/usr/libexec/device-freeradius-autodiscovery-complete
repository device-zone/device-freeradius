#!/bin/sh -x

#
# Freeradius Server Autodiscovery - Complete
# ==========================================
#
# This script creates the freeradius config from config file fragments.

set -e
umask 0027

request="${1}"


#
# sites-available
# ---------------

logger -t "${0}" "Notice: Creating /etc/raddb/sites-available/device-server..."

cat > /tmp/device-server <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

server device-server {

	listen {
		type = auth
		ipv6addr = localhost
		port = 0
	}

	listen {
		type = acct
		ipv6addr = localhost
		port = 0
	}

	authorize {
EOF

find /tmp -maxdepth 1 -name "device-server-authorize*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
	}

	authenticate {
EOF

find /tmp -maxdepth 1 -name "device-server-authenticate*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
	}

	preacct {
EOF

find /tmp -maxdepth 1 -name "device-server-preacct*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
#		acct_unique
#		files
	}

	accounting {
EOF

find /tmp -maxdepth 1 -name "device-server-accounting*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server  

cat >> /tmp/device-server <<- EOF
#		detail
#		exec
		attr_filter.accounting_response
	}

	session {
EOF

find /tmp -maxdepth 1 -name "device-server-session*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
	}

	post-auth {
EOF

find /tmp -maxdepth 1 -name "device-server-post-auth*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
	}

	pre-proxy {
EOF

find /tmp -maxdepth 1 -name "device-server-pre-proxy*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
	}

	post-proxy {
EOF

find /tmp -maxdepth 1 -name "device-server-post-proxy*" -print0 | sort -zV | xargs -0 -r cat >> /tmp/device-server

cat >> /tmp/device-server <<- EOF
	}
EOF


cat >> /tmp/device-server <<- EOF

}
EOF

install -m 640 -o root -g radiusd "/tmp/device-server" "/etc/raddb/sites-available"



#
# sites-enabled
# -------------#

if test "$1" = "start" -o "$1" = "reload"; then

  if test ! -f "/etc/device/service/radius/disabled.polar"; then
    if test ! -L "/etc/raddb/sites-enabled/device-server"; then
      ln -s "../sites-available/device-server" "/etc/raddb/sites-enabled/device-server"
    fi
    logger -t freeradius-autodiscovery "enabled freeradius."
    systemctl --no-block try-restart "radiusd"
    systemctl --no-block try-restart "freeradius-postdiscovery"
  else
    rm -f /etc/raddb/sites-enabled/device-server
    systemctl --no-block stop "freeradius-postdiscovery"
    systemctl --no-block stop "radiusd"
    logger -t freeradius-autodiscovery "disabled freeradius."
  fi

elif test "$1" = "stop"; then

  if test -f "/etc/device/system/dns/resolver/disabled.polar"; then
    rm -f /etc/raddb/sites-enabled/device-server
    systemctl --no-block stop "freeradius-postdiscovery"
    systemctl --no-block stop "radiusd"
    logger -t freeradius-autodiscovery "disabled freeradius."
  fi

fi


logger -t "${0}" "Notice: FreeRadius autodiscovery complete."

