#!/bin/sh

#
# Freeradius Autodiscovery - LDAP
# ===============================
#
# This script autogenerates the freeradius LDAP extension.

set -e
umask 0027

request="${1}"


#
# Handle LDAP
# -----------
#

cat > /tmp/device-ldap <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF


#
# Walk through each entry under replication, enable or disable as needed.
#
find /etc/device/service/radius/ldap/ -mindepth 1 -maxdepth 1 -type l | \
while read line; do

  if [ ! -L "$line/suffix.d" ]; then
    continue;
  elif [ ! -e "$line/suffix.d/name.txt" ]; then
    continue;
  elif [ ! -e "$line/suffix.d/suffix.txt" ]; then
    continue;
  elif [ ! -e "$line/suffix.d/userroot.txt" ]; then
    continue;
  elif [ ! -L "$line/suffix.d/instance.d" ]; then
    continue;
  elif [ ! -e "$line/suffix.d/instance.d/name.txt" ]; then
    continue;
  fi
  instance="$(head -n 1 $line/suffix.d/instance.d/name.txt)"
  domain="$(head -n 1 $line/suffix.d/name.txt)"
  suffix="$(head -n 1 $line/suffix.d/suffix.txt)"
  userroot="$(head -n 1 $line/suffix.d/userroot.txt)"

  if test -f "$line/.removed"; then

    # remove folder
    target=$(readlink -f "$line")
    rm -f "${target}"/* "${target}"/.removed "${target}"/.added "${target}"/.updated
    rmdir "${target}"
    rm -f "${line}"

    logger -t "${0}" "Notice: Removed ldap server '${domain}'."

  else

    # only local ldap for now
    uris="ldapi://%2frun%2fslapd-${instance}.socket"
    sasl_mech=EXTERNAL
    domains+=" ${domain}"

    cat >> /tmp/device-ldap <<- EOF

ldap ldap_${domain} {
        server = '{$uris}'
        base_dn = '${suffix}'
        sasl {
                mech = '${sasl_mech}'
        }
        update {
                reply:Reply-Message             := 'radiusReplyMessage'
                reply:Tunnel-Type               := 'radiusTunnelType'
                reply:Tunnel-Medium-Type        := 'radiusTunnelMediumType'
                reply:Tunnel-Private-Group-ID   := 'radiusTunnelPrivategroupId'
                control:                        += 'radiusControlAttribute'
                request:                        += 'radiusRequestAttribute'
                reply:                          += 'radiusReplyAttribute'
        }
        user_dn = "LDAP-UserDn"
        user {
                base_dn = "${..base_dn}"
                filter = "(uid=%{TLS-Client-Cert-Serial-Number-And-Issuer})"
        }
        group {
                base_dn = "${..base_dn}"
                filter = '(|(objectClass=groupOfNames)(objectClass=groupOfUniqueNames))'
                membership_filter = "(|(&(objectClass=groupOfNames)(member=%{control:Ldap-UserDn}))(&(objectClass=groupOfUniqueNames)(uniquemember=%{control:Ldap-UserDn})))"
        }
        profile {
                filter = '(objectclass=radiusprofile)'
                attribute = 'radiusProfileDn'
        }
EOF

    install -m 640 -o root -g radiusd "/tmp/device-ldap" "/etc/sssd/conf.d/domain-${domain}.conf"

    logger -t "${0}" "Notice: Added/updated freeradius LDAP '${domain}'."

  fi

done

install -m 640 -o root -g radiusd "/tmp/device-ldap" "/etc/raddb/mods-available/device-ldap"

ln -s "../mods-available/device-ldap" "/etc/raddb/mods-enabled"

