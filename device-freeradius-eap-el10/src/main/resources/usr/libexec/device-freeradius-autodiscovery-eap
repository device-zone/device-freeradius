#!/bin/sh -x

#
# Freeradius Autodiscovery - EAP
# ==============================
#
# This script autogenerates the freeradius EAP extension.

set -e
umask 0027

request="${1}"


#
# Handle EAP
# ----------
#

line=/etc/device/service/radius/eap/

if test ! -L "$line/default-eap-type"; then
  exit 0
fi
eaptype="$(head -n 1 $line/default-eap-type)"

if test ! -L "$line/certificate.d"; then
  continue;
else
  target=$(readlink -f "$line/certificate.d")
  uuid="$(basename $target)"
fi



#
# mods-available
# --------------

logger -t "${0}" "Notice: Adding EAP to /etc/raddb/mods-available/device-eap..."

if test -s "/run/pki-certificate/certificate-${uuid}.pem"; then

  rm -f "/run/radiusd/radius-eap-${uuid}.yaml"

  logger -t "${0}" "${request}ing radius EAP-TLS certificate..."

  redwax-tool --pem-in="/run/pki-certificate/certificate-${uuid}.pem" \
              --cert-out --chain-out --trust-out \
              --group-out=radiusd \
              --pem-out="/run/radiusd/radius-eap-${uuid}.pem" \
              --metadata-out="/run/radiusd/radius-eap-${uuid}.yaml"

  logger -t "${0}" "${request}ed EAP-TLS certificate."

fi

if test -s "$line/ca-certificate.crt"; then

  rm -f "/run/radiusd/radius-eap-ca-certificate.yaml"

  logger -t "${0}" "${request}ing EAP-TLS ca-certificate..."

  redwax-tool --trust-pem-in="$line/ca-certificate.crt" \
              --no-cert-out --no-chain-out --trust-out \
              --group-out=radiusd \
              --pem-out=/run/radiusd/radius-eap-ca-certificate.pem \
              --metadata-out="/run/radiusd/radius-eap-ca-certificate.yaml"

  logger -t "${0}" "${request}ed EAP-TLS ca-certificate."

fi

cat > /tmp/device-eap <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

eap {
        default_eap_type = ${eaptype}

        tls-config tls-common {
                private_key_file = /run/radiusd/radius-eap-${uuid}.pem
                certificate_file = /run/radiusd/radius-eap-${uuid}.pem
                ca_file = /run/radiusd/radius-eap-ca-certificate.pem
                tls_min_version = "1.2"
                tls_max_version = "1.2"

        }

        tls {
                tls = tls-common
        }

EOF

cat >> /tmp/device-eap <<- EOF
}
EOF

install -m 640 -o root -g radiusd "/tmp/device-eap" "/etc/raddb/mods-available"

# sanity check - no certificate, no eap
if test ! -s "/run/radiusd/radius-eap-${uuid}.pem"; then
  logger -t "${0}" "Notice: EAP TLS certificate not found, disabling EAP."
  exit 0
elif test ! -s "/run/radiusd/radius-eap-ca-certificate.pem"; then
  logger -t "${0}" "Notice: EAP TLS CA certificate not found, disabling EAP."
  exit 0
fi



if test "$1" = "start"; then

  if test ! -f "/etc/device/service/radius/disabled.polar"; then
    if test ! -L "/etc/raddb/mods-enabled/device-eap -a -e /etc/raddb/mods-available/device-eap"; then
      ln -s "../mods-available/device-eap" "/etc/raddb/mods-enabled/device-eap"
    fi
  else
    rm -f /etc/raddb/mods-enabled/device-eap
  fi

elif test "$1" = "stop"; then

  if test -f "/etc/device/system/dns/resolver/disabled.polar"; then

    rm -f /etc/raddb/mods-enabled/device-eap

  fi

fi



#
# sites-available
# ---------------

logger -t "${0}" "Notice: Adding EAP to /etc/raddb/sites-available/device-server..."

# authorize
cat >> /tmp/device-server-authorize-eap <<- EOF
		eap {
			ok = return
		}
		expiration
		logintime
		Autz-Type New-TLS-Connection {
			ok
		}
EOF

# authenticate
cat >> /tmp/device-server-authenticate-eap <<- EOF
                eap
EOF

# post-auth
cat >> /tmp/device-server-post-auth-eap <<- EOF
		if (&EAP-Message && !&Stripped-User-Name && &TLS-Client-Cert-Serial) {
			update request {
				&Stripped-User-Name := "%{TLS-Client-Cert-Serial-Number-And-Issuer}"
			}
		}
		update reply {
			User-Name = "%{TLS-Client-Cert-Serial-Number-And-Issuer}"
		}

		if ( EAP-Type == "EAP-TLS" ) {
##if (!(LDAP-Group == "https://gatekeeper.horizonmarine.co.za/vpn")) {
##                update reply {
##                        Reply-Message += "Connect to guest for details"
##                        #WISPr-Redirection-URL = "http://www.horizonmarine.co.za/"
##                }
##                reject
##        }
		}
		remove_reply_message_if_eap
		Post-Auth-Type REJECT {
			attr_filter.access_reject
			eap
			remove_reply_message_if_eap
		}
		if (EAP-Key-Name && &reply:EAP-Session-Id) {
			update reply {
				&EAP-Key-Name := &reply:EAP-Session-Id
			}
		}
EOF

# post-proxy
cat >> /tmp/device-server-post-proxy-eap <<- EOF
		eap
EOF



logger -t "${0}" "Notice: Added EAP to /etc/raddb/sites-available/device-server."



